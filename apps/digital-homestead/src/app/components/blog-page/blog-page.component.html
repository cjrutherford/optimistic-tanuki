<div class="blog-page-container">
  <!-- Error State -->
  @if (error()) {
  <div class="error-state">
    <p class="error-message">{{ error() }}</p>
    <otui-button (action)="dismissError()">Dismiss</otui-button>
  </div>
  }

  <div class="blog-layout">
    <!-- Sidebar with post list -->
    <aside class="blog-sidebar">
      <div class="sidebar-header">
        <h2>Blog Posts</h2>
        @if (canEdit()) {
        <otui-button (action)="startCreatePost()">New Post</otui-button>
        }
      </div>

      @if (loading() && posts().length === 0) {
      <div class="sidebar-loading">
        <p>Loading posts...</p>
      </div>
      }

      <nav class="post-list">
        @for (post of posts(); track post.id) {
        <button
          class="post-item"
          [class.active]="currentPostId() === post.id"
          [class.draft]="post.isDraft"
          (click)="selectPost(post)"
        >
          <div class="post-item-header">
            <span class="post-title">{{ post.title }}</span>
            @if (post.isDraft) {
            <span class="draft-badge">Draft</span>
            }
          </div>
          <span class="post-date">{{ formatDate(post.createdAt) }}</span>
        </button>
        } @empty { @if (!loading()) {
        <p class="no-posts">No posts yet.</p>
        } }
      </nav>
    </aside>

    <!-- Main content area -->
    <otui-card class="blog-content">
      @if (loading()) {
      <div class="loading-state">
        <p>Loading...</p>
      </div>
      } @else {
      <!-- View Mode: Show selected post or welcome message -->
      @if (mode() === 'view') { @if (selectedPost()) {
      <!-- Draft indicator banner -->
      @if (isSelectedPostDraft()) {
      <div class="draft-banner">
        <span class="draft-icon">üìù</span>
        <span class="draft-text">This post is a draft and is not published yet.</span>
        @if (isPostOwner() && canEdit()) {
        <otui-button (action)="publishDraft()">Publish Now</otui-button>
        }
      </div>
      }

      <div class="view-actions">
        @if (canEdit() && isPostOwner()) {
        <otui-button (action)="startEditPost()">Edit Post</otui-button>
        }
        @if (canEdit()) {
        <otui-button (action)="toggleThemeDesigner()">
          {{ showThemeDesigner() ? 'Hide' : 'Show' }} Theme Designer
        </otui-button>
        }
      </div>
      
      <!-- Theme Designer (only visible to users with blog editing permissions) -->
      @if (showThemeDesigner() && canEdit()) {
      <div class="theme-designer-section">
        <lib-theme-designer></lib-theme-designer>
      </div>
      }

      <dh-blog-viewer
        [title]="selectedPost()!.title"
        [content]="selectedPost()!.content"
        [authorId]="selectedPost()!.authorId"
        [createdAt]="selectedPost()!.createdAt"
      >
      </dh-blog-viewer>

      <!-- Post metadata -->
      <div class="post-metadata">
        @if (selectedPost()!.publishedAt) {
        <p class="published-date">Published: {{ formatDate(selectedPost()!.publishedAt) }}</p>
        }
        <p class="updated-date">Last updated: {{ formatDate(selectedPost()!.updatedAt) }}</p>
      </div>
      } @else {
      <div class="welcome-message">
        <h1>Welcome to the Blog</h1>
        <p>Select a post from the sidebar to read, or</p>
        @if (!isAuthenticated()) {
        <p><a routerLink="/login">Sign in</a> to create new posts.</p>
        } @else if (!hasFullAccess()) {
        <p>
          You have read-only access. Contact the site owner for editing
          permissions.
        </p>
        } @else {
        <otui-button (action)="startCreatePost()"
          >Create a New Post</otui-button
        >
        }
      </div>
      } }

      <!-- Create/Edit Mode (only shown if user has permission) -->
      @if (mode() === 'create' || mode() === 'edit') { @if (canEdit()) {
      <div class="editor-header">
        <h1>
          {{
            mode() === 'create' ? 'Create a New Blog Post' : 'Edit Blog Post'
          }}
        </h1>
        <p>
          Use the component injection system to add custom components to your
          blog post.
        </p>
        @if (mode() === 'edit' && isSelectedPostDraft()) {
        <div class="edit-draft-notice">
          <span class="draft-icon">üìù</span>
          <span>You are editing a draft. Choose to save as draft or publish when ready.</span>
        </div>
        }
      </div>

      <lib-blog-compose
        #blogCompose
        [ngModel]="editorData()"
        (postSubmitted)="onPostSubmitted($event)"
      >
      </lib-blog-compose>

      <div class="editor-actions">
        <otui-button (action)="cancelEdit()">Cancel</otui-button>
        <otui-button (action)="saveAsDraft()">Save as Draft</otui-button>
        <otui-button (action)="publishPost()">{{ mode() === 'edit' && !isSelectedPostDraft() ? 'Update & Publish' : 'Publish' }}</otui-button>
      </div>
      } @else {
      <div class="access-denied">
        <h2>Access Denied</h2>
        <p>You do not have permission to create or edit blog posts.</p>
        <otui-button (action)="cancelEdit()">Go Back</otui-button>
      </div>
      } } }
    </otui-card>
  </div>
</div>
