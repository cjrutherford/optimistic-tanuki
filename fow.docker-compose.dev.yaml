# Forge of Will Development Docker Compose Override
# This file configures services for development with debugging and hot-reload support.
#
# USAGE:
# 1. Build all applications: npm run build:dev
# 2. Start containers: docker compose -f fow.docker-compose.yaml -f fow.docker-compose.dev.yaml up -d
# 3. For hot-reload on source changes: npm run watch:build (in a separate terminal)
#
# DEBUGGING:
# - All services expose inspector ports (9000-9244) for attaching debuggers
# - Use VS Code launch configurations in .vscode/launch.json to attach to services
# - Source maps are enabled in all tsconfig.app.json files for breakpoint debugging
#
# HOT RELOAD:
# - Containers use nodemon to restart when dist files change
# - Run 'npm run watch:build' to rebuild on source file changes
# - Changes flow: src/ → nx watch → dist/ → nodemon detects → service restarts
#
services:
  authentication:
    container_name: ot_authentication # Corrected typo
    build:
      context: .
      dockerfile: ./apps/authentication/Dockerfile
    volumes:
      - ./dist/apps/authentication:/usr/src/app
      - /usr/src/app/node_modules # Ensures node_modules from the image are used
    command:
      [
        'dumb-init',
        'nodemon',
        '--exec',
        'node --inspect=0.0.0.0:9229',
        '-L',
        'main.js',
      ]
    ports:
      - '9229:9229'
    environment:
      - NODE_ENV=development
    depends_on: # Added
      postgres:
        condition: service_healthy

  forgeofwill:
    container_name: fow_client_interface # Added
    build:
      context: .
      dockerfile: ./apps/forgeofwill/Dockerfile
    volumes:
      # The new Dockerfile handles copying built assets, so direct volume mounting of dist might conflict or be unnecessary for SSR.
      # For development with hot-reloading of the SSR server, a different approach might be needed.
      # This setup assumes the Dockerfile's build process is the source of truth for the container's content.
      # If live-reloading of the Node.js server is desired, the command and volumes would need to be adjusted similar to other Node.js services.
      # For now, we remove the previous volume mounts and command that were specific to Nginx and static file serving.
      - ./apps/forgeofwill:/app/apps/forgeofwill # Mount the source code for potential rebuilds if command is adapted
      - ./libs:/app/libs # Mount libs if they are part of the build
      - ./dist/apps/forgeofwill:/app/dist/apps/forgeofwill # Mount the built dist for SSR
      - /usr/src/app/node_modules # Keep node_modules from the image
    ports:
      - "8080:4000" # Match the new exposed port
      - '9241:9241'
    # The command from the Dockerfile is `node dist/apps/forgeofwill/server/main.js`
    # For development, you might want to use nodemon or similar for the SSR server.
    # Example for nodemon (ensure nodemon is in your project or installed in the image for dev):
    command:
      [
        'dumb-init',
        'nodemon',
        '--exec',
        'node --inspect=0.0.0.0:9241',
        '-L',
        '/app/dist/apps/forgeofwill/server/server.mjs',
      ]
    environment:
      - NODE_ENV=development
      - NODE_OPTIONS=--enable-source-maps

  gateway:
    container_name: ot_gateway # Added
    build:
      context: .
      dockerfile: ./apps/gateway/Dockerfile.dev
    volumes:
      - ./dist/apps/gateway:/usr/src/app/dist/apps/gateway
      - /usr/app/node_modules # Ensures node_modules from the image are used
    command: ['dumb-init', 'nodemon', '--exec', 'node --inspect=0.0.0.0:9000', '-L', 'dist/apps/gateway/main.js']
    ports:
      - "3300:3300"
      - "3000:3000" # Expose the main port
      - "9000:9000" # Expose the debugging port
    environment:
      - NODE_ENV=development
    depends_on:
      postgres: # Added
        condition: service_healthy # Added
      authentication:
        condition: service_started
      forgeofwill:
        condition: service_started
      profile:
        condition: service_started
      social:
        condition: service_started
      # tasks:
      #   condition: service_started

  profile:
    container_name: ot_profile
    build:
      context: .
      dockerfile: ./apps/profile/Dockerfile
    volumes:
      - ./dist/apps/profile:/usr/src_app
      - /usr/src_app/node_modules # Ensures node_modules from the image are used
    command:
      [
        'dumb-init',
        'nodemon',
        '--exec',
        'node --inspect=0.0.0.0:9234',
        '-L',
        'main.js',
      ]
    ports:
      - '9234:9234'
    environment:
      - NODE_ENV=development
    depends_on: # Added
      postgres:
        condition: service_healthy

  project-planning:
    container_name: ot_project_planning
    build:
      context: .
      dockerfile: ./apps/project-planning/Dockerfile
    volumes:
      - ./dist/apps/project-planning:/usr/src_app
      - /usr/src_app/node_modules # Ensures node_modules from the image are used
    command:
      [
        'dumb-init',
        'nodemon',
        '--exec',
        'node --inspect=0.0.0.0:9231',
        '-L',
        'main.js',
      ]
    ports:
      - '9231:9231'
    environment:
      - NODE_ENV=development
    depends_on: # Added
      postgres:
        condition: service_healthy

  social:
    container_name: ot_social
    build:
      context: .
      dockerfile: ./apps/social/Dockerfile
    volumes:
      - ./dist/apps/social:/usr/src_app
      - /usr/src_app/node_modules # Ensures node_modules from the image are used
    command:
      [
        'dumb-init',
        'nodemon',
        '--exec',
        'node --inspect=0.0.0.0:9232',
        '-L',
        'main.js',
      ]
    ports:
      - '9232:9232'
    environment:
      - NODE_ENV=development
    depends_on: # Added
      postgres:
        condition: service_healthy

  chat-collector:
    container_name: ot_chat_collector
    build:
      context: .
      dockerfile: ./apps/chat-collector/Dockerfile
    volumes:
      - ./dist/apps/chat-collector:/usr/src_app
      - ./apps/chat-collector/src/assets:/usr/src/assets # Mount assets for chat collector
      - /usr/src_app/node_modules # Ensures node_modules from the image are used
    command:
      [
        'dumb-init',
        'nodemon',
        '--exec',
        'node --inspect=0.0.0.0:9233',
        '-L',
        'main.js',
      ]
    ports:
      - '9233:9233'
    environment:
      - NODE_ENV=development
    depends_on:
      postgres:
        condition: service_healthy

  # tasks:
  #   container_name: ot_tasks
  #   build:
  #     context: .
  #     dockerfile: ./apps/tasks/Dockerfile
  #   volumes:
  #     - ./dist/apps/tasks:/usr/src/app
  #     - /usr/src/app/node_modules # Ensures node_modules from the image are used
  #   command: ["dumb-init", "nodemon", "-L", "main.js"]
  #   environment:
  #     - NODE_ENV=development
  #   depends_on: # Added
  #     postgres:
  #       condition: service_healthy
  
  assets:
    container_name: ot_assets
    build:
      context: .
      dockerfile: ./apps/assets/Dockerfile
    volumes:
      - ./dist/apps/assets:/usr/src_app
      - /usr/src_app/node_modules # Ensures node_modules from the image are used
      - ../fow-assets:/usr/src_app/storage
    command:
      [
        'dumb-init',
        'nodemon',
        '--exec',
        'node --inspect=0.0.0.0:9244',
        '-L',
        'main.js',
      ]
    ports:
      - '9244:9244'
    environment:
      - NODE_ENV=development
    depends_on: # Added
      postgres:
        condition: service_healthy


  ai-orchestration:
    container_name: ot_ai_orchestration
    build:
      context: .
      dockerfile: ./apps/ai-orchestrator/Dockerfile
    volumes:
      - ./dist/apps/ai-orchestrator:/usr/src_app
      - ./apps/ai-orchestrator/src/assets:/usr/src/assets # Mount assets for AI Orchestrator
      - /usr/src_app/node_modules # Ensures node_modules from the image are used
    command:
      [
        'dumb-init',
        'nodemon',
        '--exec',
        'node --inspect=0.0.0.0:9236',
        '-L',
        'main.js',
      ]
    ports:
      - '9236:9236'
    environment:
      - NODE_ENV=development
    depends_on: # Added
      postgres:
        condition: service_healthy

  prompt-proxy: 
    container_name: ot_prompt_proxy
    build:
      context: .
      dockerfile: ./apps/prompt-proxy/Dockerfile
    volumes:
      - ./dist/apps/prompt-proxy:/usr/src_app
      - ./apps/prompt-proxy/src/assets:/usr/src/assets # Mount assets for prompt proxy
      - /usr/src_app/node_modules # Ensures node_modules from the image are used
    command:
      [
        'dumb-init',
        'nodemon',
        '--exec',
        'node --inspect=0.0.0.0:9237',
        '-L',
        'main.js',
      ]
    ports:
      - '9237:9237'
    environment:
      - NODE_ENV=development
    depends_on: # Added
      postgres:
        condition: service_healthy

  telos-docs-service:
    container_name: ot_telos_docs_service
    build:
      context: .
      dockerfile: ./apps/telos-docs-service/Dockerfile
    volumes:
      - ./dist/apps/telos-docs-service:/usr/src_app
      - /usr/src_app/node_modules # Ensures node_modules from the image are used
    command:
      [
        'dumb-init',
        'nodemon',
        '--exec',
        'node --inspect=0.0.0.0:9238',
        '-L',
        'main.js',
      ]
    ports:
      - '9238:9238'
    environment:
      - NODE_ENV=development
    depends_on: # Added
      postgres:
        condition: service_healthy
